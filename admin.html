<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel ‚Äî PhytoLab</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-ocean: linear-gradient(135deg, #0a2a3a 0%, #1e3a5f 50%, #2d5a7a 100%);
            --accent-seafoam: #7FFFD4;
            --glass: rgba(255, 255, 255, 0.08);
            --text-light: #e0f7fa;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-ocean);
            color: var(--text-light);
            padding: 40px;
            min-height: 100vh;
        }
        .admin-container { max-width: 1000px; margin: 0 auto; }
        .form-card {
            background: var(--glass);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }
        h2 { color: var(--accent-seafoam); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: rgba(30, 58, 95, 0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-light);
            border-radius: 8px;
            outline: none;
        }
        button {
            background: var(--accent-seafoam);
            color: #0a2a3a;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s;
        }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .item-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .item-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-delete { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .category-item-text {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .category-controls {
            display: flex;
            gap: 5px;
        }
        .btn-move { background: #6366f1; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-move:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<script>
    (function() {
        const password = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
        if (password !== "1234") { 
            alert("–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ!");
            window.location.href = "index.html"; 
        }
    })();
</script>

<div class="admin-container">
    <h1>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è PhytoLab ‚öôÔ∏è</h1>
    <p><a href="index.html" style="color: var(--accent-seafoam); text-decoration: none;">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É</a></p>
    
    <div class="form-card">
        <h2 id="form-title">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h2>
        <form id="product-form">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="p-name" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ú—É—Ö–æ–º–æ—Ä–Ω–∏–π —á–∞–π">
            </div>
            <div class="form-group">
                <label>–¶—ñ–Ω–∞ (–≥—Ä–Ω)</label>
                <input type="number" id="p-price" required placeholder="500">
            </div>
            <div class="form-group">
                <label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ (URL)</label>
                <input type="text" id="p-img" required placeholder="–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (https://...)">
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å</label>
                <textarea id="p-desc" rows="3" placeholder="–û–ø–∏—à—ñ—Ç—å —Ç–æ–≤–∞—Ä..."></textarea>
            </div>
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select id="p-category" required>
                    <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
                    <option value="–î–õ–Ø –°–ù–£">–î–õ–Ø –°–ù–£</option>
                    <option value="–ö–û–ù–¶–ï–ù–¢–†–ê–¶–Ü–Ø">–ö–û–ù–¶–ï–ù–¢–†–ê–¶–Ü–Ø</option>
                    <option value="–†–û–ó–°–õ–ê–ë–õ–ï–ù–ù–Ø">–†–û–ó–°–õ–ê–ë–õ–ï–ù–ù–Ø</option>
                    <option value="–õ–Ü–ë–Ü–î–û">–õ–Ü–ë–Ü–î–û</option>
                    <option value="–í–Ü–î–ü–û–ß–ò–ù–û–ö">–í–Ü–î–ü–û–ß–ò–ù–û–ö</option>
                </select>
            </div>
            <button type="submit" id="submit-btn">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–æ–≤–∞—Ä</button>
            <button type="button" id="cancel-btn" style="display:none; background:#555; color: white;">–í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
        </form>
    </div>

    <h2>–¢–æ–≤–∞—Ä–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö</h2>
    <div class="product-list" id="admin-product-grid">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <div class="form-card">
        <h2>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–æ–≤–∏–Ω–∫–∞–º–∏</h2>
        <div style="margin-bottom: 20px;">
            <select id="new-select" style="width: 70%; margin-right: 10px;">
                <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è –Ω–æ–≤–∏–Ω–æ–∫</option>
            </select>
            <button onclick="addToNew()">–î–æ–¥–∞—Ç–∏ –¥–æ –Ω–æ–≤–∏–Ω–æ–∫</button>
        </div>
        <div id="new-list"></div>
    </div>

    <div class="form-card">
        <h2>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–æ–ø–æ–≤–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏</h2>
        <div style="margin-bottom: 20px;">
            <select id="top-select" style="width: 70%; margin-right: 10px;">
                <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è —Ç–æ–ø–æ–≤–∏—Ö</option>
            </select>
            <button onclick="addToTop()">–î–æ–¥–∞—Ç–∏ –¥–æ —Ç–æ–ø–æ–≤–∏—Ö</button>
        </div>
        <div id="top-list"></div>
    </div>

    <div class="form-card">
        <h2>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</h2>
        <div style="margin-bottom: 20px;">
            <input type="text" id="new-category" placeholder="–ù–∞–∑–≤–∞ –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó" style="width: 70%; margin-right: 10px;">
            <button onclick="addCategory()">–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</button>
        </div>
        <div id="category-list"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCoMilBNzczqZh_KVJVwvpt24EOgK5NnHQ",
        authDomain: "hapevasek.firebaseapp.com",
        databaseURL: "https://hapevasek-default-rtdb.firebaseio.com",
        projectId: "hapevasek",
        storageBucket: "hapevasek.firebasestorage.app",
        messagingSenderId: "534239781720",
        appId: "1:534239781720:web:c1777589cf46d5cff97b2d"
    };

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    let cachedProducts = {};
    let newArrivals = [];
    let topSellers = [];
    let categories = [];

    const form = document.getElementById('product-form');
    const grid = document.getElementById('admin-product-grid');

    // –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
    function fetchProducts() {
        db.ref('products').on('value', (snapshot) => {
            grid.innerHTML = '';
            const data = snapshot.val();
            cachedProducts = data || {};
            if (data) {
                Object.keys(data).forEach((id) => {
                    const p = data[id];
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <img src="${p.img}" onerror="this.src='https://via.placeholder.com/150'" alt="">
                        <h3>${p.name}</h3>
                        <p>${p.price} –≥—Ä–Ω</p>
                        <small>${p.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'}</small>
                        <div class="actions">
                            <button class="btn-edit" onclick="prepareEdit('${id}')">‚úé</button>
                            <button class="btn-delete" onclick="deleteProduct('${id}')">üóë</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p>–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ–º–∞—î</p>';
            }
            populateSelects();
        }, (error) => {
            console.error("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è:", error);
            grid.innerHTML = '<p style="color:red">–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö!</p>';
        });
    }

    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('edit-id').value;
        const productData = {
            name: document.getElementById('p-name').value,
            price: document.getElementById('p-price').value,
            img: document.getElementById('p-img').value,
            description: document.getElementById('p-desc').value,
            category: document.getElementById('p-category').value,
            timestamp: Date.now()
        };

        try {
            if (id) {
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è
                await db.ref('products/' + id).update(productData);
                alert('–¢–æ–≤–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ!');
            } else {
                // –î–æ–¥–∞–≤–∞–Ω–Ω—è
                await db.ref('products').push(productData);
                alert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
            }
            resetForm();
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É:", error);
            alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
        }
    });

    // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    window.prepareEdit = (id) => {
        db.ref('products/' + id).once('value', (snap) => {
            const p = snap.val();
            if (!p) return;

            document.getElementById('p-name').value = p.name || '';
            document.getElementById('p-price').value = p.price || '';
            document.getElementById('p-img').value = p.img || '';
            document.getElementById('p-desc').value = p.description || p.desc || '';
            document.getElementById('p-category').value = p.category || '';
            document.getElementById('edit-id').value = id;
            
            document.getElementById('form-title').innerText = "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä";
            document.getElementById('submit-btn').innerText = "–û–Ω–æ–≤–∏—Ç–∏";
            document.getElementById('cancel-btn').style.display = "inline-block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    };

    // –í–∏–¥–∞–ª–µ–Ω–Ω—è
    window.deleteProduct = (id) => {
        if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä?')) {
            // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ products
            db.ref('products/' + id).remove()
                .then(() => {
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ newArrivals —è–∫—â–æ —î
                    const newIndex = newArrivals.indexOf(id);
                    if (newIndex > -1) {
                        newArrivals.splice(newIndex, 1);
                        db.ref('newArrivals').set(newArrivals);
                    }
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ topSellers —è–∫—â–æ —î
                    const topIndex = topSellers.indexOf(id);
                    if (topIndex > -1) {
                        topSellers.splice(topIndex, 1);
                        db.ref('topSellers').set(topSellers);
                    }
                    alert('–í–∏–¥–∞–ª–µ–Ω–æ');
                })
                .catch(err => alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message));
        }
    };

    function resetForm() {
        form.reset();
        document.getElementById('edit-id').value = "";
        document.getElementById('form-title').innerText = "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä";
        document.getElementById('submit-btn').innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–æ–≤–∞—Ä";
        document.getElementById('cancel-btn').style.display = "none";
    }

    document.getElementById('cancel-btn').onclick = resetForm;

    // –ó–∞–ø—É—Å–∫
    fetchProducts();

    db.ref('newArrivals').on('value', (snapshot) => {
        newArrivals = snapshot.val() || [];
        renderNewList();
    });

    db.ref('topSellers').on('value', (snapshot) => {
        topSellers = snapshot.val() || [];
        renderTopList();
    });

    db.ref('categories').on('value', (snapshot) => {
        categories = snapshot.val() || [];
        if (categories.length === 0) {
            // –î–æ–¥–∞—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
            categories = ['–Ü–Ω–≥–∞–ª—è—Ç–æ—Ä–∏', '–†–µ—á–æ–≤–∏–Ω–∏ –¥–ª—è —ñ–Ω–≥–∞–ª—è—Ç–æ—Ä—ñ–≤', '–î–∏—Å—Ç–∏–ª—è—Ç–∏', '–ú—ñ–Ω—ñ –ë–æ–Ω–≥–∏', '–ì—Ä–∏–Ω–¥–µ—Ä–∏-–ø–æ–¥—Ä—ñ–±–Ω—é–≤–∞—á—ñ', '–ö–æ–≤–ø–∞–∫–∏(–ù–∞–ø–µ—Ä—Å—Ç–∫–∏)', '–°—É—Ü–≤—ñ—Ç—Ç—è', '–ö–æ—Å—è–∫–∏'];
            db.ref('categories').set(categories);
        }
        renderCategoryList();
        populateCategorySelect();
    });

    function populateSelects() {
        const newSelect = document.getElementById('new-select');
        const topSelect = document.getElementById('top-select');
        newSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è –Ω–æ–≤–∏–Ω–æ–∫</option>';
        topSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è —Ç–æ–ø–æ–≤–∏—Ö</option>';
        Object.keys(cachedProducts).forEach(id => {
            const p = cachedProducts[id];
            const option = `<option value="${id}">${p.name}</option>`;
            newSelect.innerHTML += option;
            topSelect.innerHTML += option;
        });
    }

    function renderNewList() {
        const container = document.getElementById('new-list');
        container.innerHTML = '';
        newArrivals.forEach(id => {
            const p = cachedProducts[id];
            if (p) {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.marginBottom = '5px';
                div.innerHTML = `<span>${p.name}</span><button onclick="removeFromNew('${id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
                container.appendChild(div);
            }
        });
    }

    function renderTopList() {
        const container = document.getElementById('top-list');
        container.innerHTML = '';
        topSellers.forEach(id => {
            const p = cachedProducts[id];
            if (p) {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center'; div.style.marginBottom = '5px';
                div.innerHTML = `<span>${p.name}</span><button onclick="removeFromTop('${id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
                container.appendChild(div);
            }
        });
    }

    window.addToNew = () => {
        const select = document.getElementById('new-select');
        const id = select.value;
        if (!id || newArrivals.includes(id)) return;
        newArrivals.push(id);
        db.ref('newArrivals').set(newArrivals);
        select.value = '';
    };

    window.addToTop = () => {
        const select = document.getElementById('top-select');
        const id = select.value;
        if (!id || topSellers.includes(id)) return;
        topSellers.push(id);
        db.ref('topSellers').set(topSellers);
        select.value = '';
    };

    window.removeFromNew = (id) => {
        const index = newArrivals.indexOf(id);
        if (index > -1) {
            newArrivals.splice(index, 1);
            db.ref('newArrivals').set(newArrivals);
        }
    };

    window.removeFromTop = (id) => {
        const index = topSellers.indexOf(id);
        if (index > -1) {
            topSellers.splice(index, 1);
            db.ref('topSellers').set(topSellers);
        }
    };

    window.addCategory = () => {
        const input = document.getElementById('new-category');
        const cat = input.value.trim();
        if (!cat || categories.includes(cat)) return;
        categories.push(cat);
        db.ref('categories').set(categories);
        input.value = '';
    };

    window.removeCategory = (cat) => {
        const index = categories.indexOf(cat);
        if (index > -1) {
            categories.splice(index, 1);
            db.ref('categories').set(categories);
        }
    };

    window.moveCategory = (index, direction) => {
        if (direction === -1 && index > 0) {
            // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö
            [categories[index], categories[index - 1]] = [categories[index - 1], categories[index]];
            db.ref('categories').set(categories);
        } else if (direction === 1 && index < categories.length - 1) {
            // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑
            [categories[index], categories[index + 1]] = [categories[index + 1], categories[index]];
            db.ref('categories').set(categories);
        }
    };

    function renderCategoryList() {
        const container = document.getElementById('category-list');
        container.innerHTML = '';
        categories.forEach((cat, index) => {
            const div = document.createElement('div');
            div.className = 'category-item';
            const moveUp = index > 0;
            const moveDown = index < categories.length - 1;
            div.innerHTML = `
                <div class="category-item-text">
                    <span style="font-weight: 600;">${cat}</span>
                </div>
                <div class="category-controls">
                    <button class="btn-move" onclick="moveCategory(${index}, -1)" ${!moveUp ? 'disabled' : ''}>‚Üë</button>
                    <button class="btn-move" onclick="moveCategory(${index}, 1)" ${!moveDown ? 'disabled' : ''}>‚Üì</button>
                    <button class="btn-delete" onclick="removeCategory('${cat}')">üóë</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function populateCategorySelect() {
        const select = document.getElementById('p-category');
        select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
    }
</script>
</body>
</html>
